# 🤖 DERL 机器人可视化指南

## 快速开始

### 基础用法

```bash
# 显示第N个机器人（索引从0开始）
./show_robot.sh <索引>

# 示例：
./show_robot.sh 0          # 显示第一个机器人
./show_robot.sh 500        # 显示第500个机器人  
./show_robot.sh 1158       # 显示最后一个机器人
```

### 无参数运行（显示帮助）

```bash
./show_robot.sh
```

---

## MuJoCo 窗口控制

| 操作 | 说明 |
|-----|------|
| **右键拖动** | 旋转视角 |
| **中键拖动** | 平移视图 |
| **鼠标滚轮** | 缩放（放大/缩小） |
| **ESC键** | 退出可视化 |
| **关闭窗口** | 退出可视化 |

---

## 主要特性

✅ **自动启用Floor（地板）**
- XML中的floor被注释，脚本自动启用以获得视觉参考
- 地板显示为灰色网格

✅ **实时摄像头跟踪**
- 摄像头焦点自动跟随机器人躯干
- 机器人运动时视角自动调整

✅ **自动摄像头配置**
- 根据机器人尺寸自动计算最优观看距离
- 俯视角度（-20°）方便观察肢体结构

✅ **完整机器人渲染**
- 躯干（球形）
- 肢体（胶囊形）
- 地板（平面）
- 支撑适当的物理仿真

---

## 统计信息

### 生成的机器人

- **总数量**：1159个
- **来源**：初始化阶段（5760候选 → 去重 → 1159个）
- **平均组成**：
  - Bodies：7-8个
  - Geoms：6-7个
  - Joints：8-9个
  - 尺寸范围：0.3-1.3米

### 查看统计信息

```bash
# 检查所有机器人
python tools/inspect_robots.py

# 随机抽样50个机器人
python tools/inspect_robots.py --sample 50
```

---

## 常见问题

### Q: 为什么看不到地板？
**A:** 脚本会自动启用注释掉的floor元素。如果还是看不到，可能是摄像头角度问题。
- 尝试用右键拖动调整视角
- 用滚轮放大以获得更好的视图

### Q: 机器人一开始能看到，后来就看不到了？
**A:** 这是因为机器人可能运动出了初始视角范围，但摄像头会自动跟踪躯干位置。
- 脚本会持续更新摄像头焦点
- 如果还是看不到，尝试用右键拖动重新调整视角

### Q: 如何快速循环查看多个机器人？
**A:** 打开多个终端窗口或标签，分别运行不同的索引：
```bash
./show_robot.sh 0 &
./show_robot.sh 500 &
./show_robot.sh 1000 &
```

### Q: 为什么有些机器人比其他的大或小？
**A:** 这是因为在初始化过程中，不同的机器人有不同的肢体配置：
- 肢体数量不同（3-10个肢体）
- 肢体长度不同（随机采样）
- 躯干大小不同

---

## 脚本详情

### show_robot.sh
- **用途**：环境激活和参数传递的包装脚本
- **功能**：
  - 激活conda环境
  - 自动检测总机器人数
  - 提供友好的帮助信息
  - 调用Python可视化脚本

### tools/show_robot.py
- **用途**：实际的可视化实现
- **关键功能**：
  - 从XML文件加载机器人
  - 自动修复XML（启用floor）
  - MuJoCo仿真和渲染
  - 摄像头跟踪机器人运动

### tools/inspect_robots.py
- **用途**：机器人统计和质量检查
- **功能**：
  - 分析所有机器人配置
  - 生成统计报告
  - 检测异常或错误的XML文件

---

## 技术细节

### 可视化流程

1. **加载XML文件** → 从 `output/lunar_jump/xml/` 读取
2. **修复XML** → 取消注释floor元素
3. **创建MuJoCo模型** → `load_model_from_xml()`
4. **初始化仿真** → `MjSim(model)`
5. **创建查看器** → `MjViewer(sim)`
6. **运行循环** → 每帧更新摄像头焦点和渲染

### 摄像头跟踪实现

```python
# 每帧更新摄像头焦点
torso_pos = sim.data.body_xpos[torso_body_id]
viewer.cam.lookat[:] = [torso_pos[0], torso_pos[1], torso_pos[2] * 0.7]
```

---

## 已知限制

- ⚠️ 仅支持Linux/macOS（因为需要X11显示）
- ⚠️ 需要GPU和OpenGL支持（MuJoCo渲染）
- ⚠️ 所有机器人都是初始化候选，未经PPO训练

---

## 下一步

### 如果要查看已训练的机器人
需要完成以下流程：
1. **Stage 1**：PPO训练初始种群（576个机器人）
2. **Stage 2**：进化和训练（持续增加种群）

运行：
```bash
PYTHONPATH=. python tools/evolution.py --cfg configs/evo/lunar_jump.yml
```

---

## 相关文件

- `output/lunar_jump/xml/` - 机器人XML文件（1159个）
- `derl/envs/morphology.py` - 机器人结构定义
- `derl/utils/similarity.py` - 机器人相似度计算
- `derl/envs/assets/unimal.xml` - 机器人XML模板

---

**最后更新**：2026年1月30日
