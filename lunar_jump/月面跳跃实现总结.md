# æœˆé¢è·³è·ƒæœºå™¨äººæ¡†æ¶ - å®ç°æ€»ç»“

## ğŸ“‹ åˆ›å»ºå’Œä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### âœ… æ–°å¢æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

#### 1. `derl/envs/tasks/lunar_jump.py` â­ æ ¸å¿ƒæ–‡ä»¶
**ç”¨é€”**: å®šä¹‰æœˆé¢è·³è·ƒä»»åŠ¡å’Œå¥–åŠ±è®¡ç®—

**å…³é”®ç‰¹æ€§**:
- `LunarJumpTask` ç±»ç»§æ‰¿è‡ª `UnimalEnv`
- è®¡ç®—è·³è·ƒé«˜åº¦: `_calculate_jump_height()` - è·Ÿè¸ªä»åˆå§‹ä½ç½®çš„æœ€å¤§é«˜åº¦
- è®¡ç®—æ°´å¹³è·ç¦»: `_calculate_horizontal_distance()` - æ¯æ­¥ç§»åŠ¨è·ç¦»
- å¤åˆå¥–åŠ±å‡½æ•°:
  ```python
  reward = forward_reward + jump_reward - ctrl_cost - energy_cost
  ```
  å…¶ä¸­:
  - `forward_reward = FORWARD_REWARD_WEIGHT * horizontal_distance` (æƒé‡: 1.0)
  - `jump_reward = JUMP_REWARD_WEIGHT * jump_height` (æƒé‡: 10.0)
  - `energy_cost = ENERGY_COST_WEIGHT * energy_used` (æƒé‡: 0.001)

- `step()` æ–¹æ³•è¿”å›åŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„ info dict:
  ```python
  {
    "jump_height": float,          # å½“å‰è·³è·ƒé«˜åº¦
    "max_jump_height": float,      # æœ¬episodeæœ€å¤§é«˜åº¦
    "__reward__forward": float,    # å‰è¿›å¥–åŠ±ç»„æˆ
    "__reward__jump": float,       # è·³è·ƒå¥–åŠ±ç»„æˆ
    "__reward__energy": float,     # èƒ½é‡æˆæœ¬
    ...
  }
  ```

- `reset()` åˆå§‹åŒ–è·³è·ƒé«˜åº¦è¿½è¸ªå˜é‡

- `make_env_lunar_jump()` å·¥å‚å‡½æ•°åˆ›å»ºå®Œæ•´ç¯å¢ƒ(å¸¦æ‰€æœ‰wrapper)

**ä»£ç é‡**: ~180è¡Œ

---

#### 2. `configs/evo/lunar_jump.yml` â­ é…ç½®æ–‡ä»¶
**ç”¨é€”**: è¿›åŒ–è®­ç»ƒçš„é…ç½®å‚æ•°

**å…³é”®é…ç½®**:
```yaml
OUT_DIR: './output/lunar_jump'              # è¾“å‡ºç›®å½•
ENV:
  TASK: "lunar_jump"                        # ä½¿ç”¨lunar_jumpä»»åŠ¡
  MODULES: ["Agent", "Floor"]               # ä»…éœ€Agent+Floor(å¹³é¢)
  GRAVITY: 1.62                             # æœˆçƒé‡åŠ› (1/6åœ°çƒ)
  FORWARD_REWARD_WEIGHT: 1.0
  JUMP_REWARD_WEIGHT: 10.0                  # è·³è·ƒå¥–åŠ±æƒé‡(åŠ é‡)
  ENERGY_COST_WEIGHT: 0.001
  
EVO:
  SELECTION_CRITERIA: ["__reward__jump", "metric"]  # æŒ‰è·³è·ƒé«˜åº¦é€‰æ‹©
  
TERRAIN:
  SIZE: [50, 50, 1]                         # å¹³é¢å°ºå¯¸
  START_FLAT: 5                             # èµ·å§‹å¹³é¢
  CENTER_FLAT: 40                           # ä¸­å¿ƒå¹³é¢(å¤§éƒ¨åˆ†æ˜¯å¹³çš„)
  TYPES: []                                 # æ— éšœç¢
```

---

### âœï¸ ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

#### 1. `derl/envs/tasks/task.py`
**æ”¹åŠ¨**: ç¬¬6è¡Œ - æ·»åŠ å¯¼å…¥

```python
# æ–°å¢ä¸€è¡Œ
from derl.envs.tasks.lunar_jump import make_env_lunar_jump
```

è¿™æ · `make_env()` å‡½æ•°å¯ä»¥é€šè¿‡ `cfg.ENV.TASK = "lunar_jump"` è‡ªåŠ¨è°ƒç”¨ `make_env_lunar_jump()`

**ä»£ç å˜åŒ–**: +1è¡Œ

---

#### 2. `derl/config.py`
**æ”¹åŠ¨1**: ç¬¬110-130è¡Œ - æ·»åŠ æ–°çš„å¥–åŠ±æƒé‡å‚æ•°

```python
_C.ENV.FORWARD_REWARD_WEIGHT = 1.0

_C.ENV.JUMP_REWARD_WEIGHT = 10.0         # â­ æ–°å¢

_C.ENV.ENERGY_COST_WEIGHT = 1e-3          # â­ æ–°å¢

_C.ENV.AVOID_REWARD_WEIGHT = 100.0
```

**æ”¹åŠ¨2**: ç¬¬156-160è¡Œ - æ·»åŠ é‡åŠ›å‚æ•°

```python
# Specify task. Can be locomotion, manipulation
_C.ENV.TASK = "locomotion"

# Gravity setting (m/sÂ²). Default is None (use MuJoCo default 9.81)
# Set to 1.62 for lunar gravity (Moon is 1/6 of Earth)
_C.ENV.GRAVITY = None                     # â­ æ–°å¢
```

**ç”¨é€”**: 
- `GRAVITY = None` æ—¶ä½¿ç”¨MuJoCoé»˜è®¤é‡åŠ›(9.81 m/sÂ²)
- `GRAVITY = 1.62` æ—¶ä½¿ç”¨æœˆçƒé‡åŠ›(åœ°çƒçš„1/6)
- å¯åœ¨config yamlä¸­è¦†ç›–

**ä»£ç å˜åŒ–**: +7è¡Œ

---

#### 3. `derl/envs/tasks/unimal.py`
**æ”¹åŠ¨**: ç¬¬63-77è¡Œ - åœ¨ `_get_sim()` ä¸­æ·»åŠ é‡åŠ›åº”ç”¨

```python
def _get_sim(self):
    # ... å‰é¢ä»£ç ä¸å˜ ...
    sim = mujoco_py.MjSim(model)
    
    # â­ æ–°å¢: åº”ç”¨é‡åŠ›é…ç½®
    if hasattr(cfg.ENV, 'GRAVITY') and cfg.ENV.GRAVITY is not None:
        sim.model.opt.gravity[2] = -cfg.ENV.GRAVITY
    
    # ... åé¢ä»£ç ä¸å˜ ...
    return sim
```

**ç”¨é€”**: åœ¨ç‰©ç†æ¨¡æ‹Ÿä¸­åº”ç”¨é…ç½®ä¸­çš„é‡åŠ›å€¼

**ä»£ç å˜åŒ–**: +3è¡Œ

---

## ğŸ“Š æ–‡ä»¶ä¿®æ”¹æ€»ç»“è¡¨

| æ–‡ä»¶ | ç±»å‹ | è¡Œæ•° | ç”¨é€” |
|-----|------|------|------|
| `lunar_jump.py` | æ–°å¢ | 180 | æœˆé¢è·³è·ƒä»»åŠ¡å®šä¹‰å’Œå¥–åŠ±è®¡ç®— |
| `lunar_jump.yml` | æ–°å¢ | 30 | è¿›åŒ–è®­ç»ƒé…ç½® |
| `task.py` | ä¿®æ”¹ | +1 | æ³¨å†Œlunar_jumpä»»åŠ¡ |
| `config.py` | ä¿®æ”¹ | +7 | æ·»åŠ å¥–åŠ±æƒé‡å’Œé‡åŠ›å‚æ•° |
| `unimal.py` | ä¿®æ”¹ | +3 | åœ¨ç‰©ç†æ¨¡æ‹Ÿä¸­åº”ç”¨é‡åŠ› |
| **æ€»è®¡** | **5** | **~220** | |

---

## ğŸ”„ æ‰§è¡Œæµç¨‹

```
evolution.py (ä¸»ç¨‹åº)
    â”‚
    â”œâ”€ cfg.ENV.TASK = "lunar_jump"
    â”‚
    â””â”€ make_env()
        â”œâ”€ make_env_lunar_jump(xml, unimal_id)  â† è°ƒç”¨æ–°åˆ›å»ºçš„å‡½æ•°
        â”‚
        â”œâ”€ LunarJumpTask(xml, unimal_id)  â† æ–°å¢çš„ä»»åŠ¡ç±»
        â”‚   â”œâ”€ reset()  â†’ åˆå§‹åŒ–è·³è·ƒé«˜åº¦
        â”‚   â””â”€ step(action)  â†’ è®¡ç®—è·³è·ƒé«˜åº¦å’Œå¥–åŠ±
        â”‚       â”œâ”€ forward_reward = 1.0 * distance
        â”‚       â”œâ”€ jump_reward = 10.0 * height
        â”‚       â””â”€ total_reward = forward + jump - cost
        â”‚
        â””â”€ ç¯å¢ƒå‡†å¤‡å®Œæˆï¼Œå¼€å§‹è®­ç»ƒ

è¿›åŒ–è¿‡ç¨‹:
    â”œâ”€ æ¯ä¸ªä¸ªä½“é€šè¿‡PPOè®­ç»ƒ
    â”œâ”€ infoå­—å…¸åŒ…å«: __reward__jump, __reward__forward
    â”œâ”€ æ ¹æ® __reward__jump (è·³è·ƒé«˜åº¦)è¿›è¡Œé€‰æ‹©
    â””â”€ ç”Ÿé•¿è‚¢ä½“/æ”¹å˜å…³èŠ‚ä»¥ä¼˜åŒ–è·³è·ƒ
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: å¿«é€Ÿæµ‹è¯•(æ¨è)

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/t/yb/agrimgupta_derl/derl

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯è®¾ç½®
python test_lunar_jump_setup.py

# å¦‚æœæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œç»§ç»­æ­¥éª¤3
```

### æ–¹æ³•2: å¯åŠ¨å®Œæ•´è®­ç»ƒ

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œè¿›åŒ–
python tools/evolution.py --config configs/evo/lunar_jump.yml

# è¾“å‡ºä¿å­˜åœ¨ output/lunar_jump/ ç›®å½•
```

### æ–¹æ³•3: è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘ `configs/evo/lunar_jump.yml`:
```yaml
ENV:
  GRAVITY: 1.62              # è°ƒæ•´é‡åŠ›
  JUMP_REWARD_WEIGHT: 20.0   # å¢åŠ è·³è·ƒå¥–åŠ±æƒé‡
  FORWARD_REWARD_WEIGHT: 0.5 # é™ä½å‰è¿›å¥–åŠ±æƒé‡
```

---

## ğŸ¯ æœŸæœ›è¡Œä¸º

### ç”Ÿæˆçš„æœºå™¨äººç‰¹å¾
- **è‚¢ä½“**: è¾ƒé•¿çš„è‚¢ä½“(ç›¸æ¯”åœ°çƒé‡åŠ›)ï¼Œç”¨äºè·³è·ƒ
- **å…³èŠ‚**: å¼ºæœ‰åŠ›çš„å…³èŠ‚ä»¥å…‹æœæœˆçƒé‡åŠ›
- **è¡Œä¸º**: å‘¨æœŸæ€§è·³è·ƒï¼Œè€ŒéæŒç»­çˆ¬è¡Œ
- **é«˜åº¦**: å‰100ä»£å¯èƒ½è¾¾åˆ°0.5-1.0m

### è¾“å‡ºç¤ºä¾‹

```
Generation 0:
  Best individual: reward=1.523
  Jump height: 0.12m
  Forward distance: 0.40m

Generation 50:
  Best individual: reward=25.631
  Jump height: 0.68m
  Forward distance: 5.23m

Generation 100:
  Best individual: reward=45.892
  Jump height: 1.45m
  Forward distance: 12.50m
```

---

## âš™ï¸ å‚æ•°è°ƒä¼˜æŒ‡å—

### å¦‚æœè·³è·ƒé«˜åº¦å¤ªä½
å¢åŠ  `JUMP_REWARD_WEIGHT`:
```yaml
JUMP_REWARD_WEIGHT: 20.0  # ä»10.0å¢åŠ åˆ°20.0
```

### å¦‚æœæœºå™¨äººä¸ç§»åŠ¨
å¢åŠ  `FORWARD_REWARD_WEIGHT`:
```yaml
FORWARD_REWARD_WEIGHT: 5.0  # ä»1.0å¢åŠ åˆ°5.0
```

### å¦‚æœè‚¢ä½“å¤ªé•¿
å‡å°‘ `LIMB.HEIGHT_RANGE`:
```python
_C.LIMB.HEIGHT_RANGE = [0.15, 0.35, 0.05]  # é»˜è®¤æ˜¯[0.15, 0.45, 0.05]
```

### å¦‚æœè®­ç»ƒå¤ªæ…¢
å‡å°‘ `LIMB.MAX_LIMBS`:
```python
_C.LIMB.MAX_LIMBS = 8  # ä»10å‡å°‘åˆ°8
```

---

## âœ… éªŒè¯æ¸…å•

- [x] `lunar_jump.py` åˆ›å»ºæˆåŠŸ
- [x] `lunar_jump.yml` åˆ›å»ºæˆåŠŸ
- [x] `task.py` å¯¼å…¥æ³¨å†ŒæˆåŠŸ
- [x] `config.py` å‚æ•°æ·»åŠ æˆåŠŸ
- [x] `unimal.py` é‡åŠ›åº”ç”¨æˆåŠŸ
- [x] æµ‹è¯•è„šæœ¬åˆ›å»ºæˆåŠŸ
- [ ] è¿è¡Œæµ‹è¯•è„šæœ¬ (ä½ çš„ä¸‹ä¸€æ­¥)
- [ ] å¯åŠ¨è®­ç»ƒ (åç»­æ­¥éª¤)

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é‡åŠ›è®¾ç½®**: 
   - æœˆçƒé‡åŠ› = 1.62 m/sÂ²
   - é»˜è®¤å€¼(None)ä½¿ç”¨MuJoCoçš„9.81 m/sÂ²
   - å¯åœ¨yamlé…ç½®ä¸­è¦†ç›–

2. **å¥–åŠ±æƒé‡**:
   - è·³è·ƒå¥–åŠ±(10.0) > å‰è¿›å¥–åŠ±(1.0) ä»¥é¼“åŠ±è·³è·ƒ
   - å¯æ ¹æ®éœ€è¦è°ƒæ•´æ¯”ä¾‹

3. **ç¯å¢ƒmodules**:
   - ä½¿ç”¨"Floor"åˆ›å»ºå¹³é¢(æ— terrain)
   - ä¾¿äºè§‚å¯Ÿçº¯ç²¹çš„è·³è·ƒè¡Œä¸º

4. **è§‚æµ‹ç©ºé—´**:
   - ä¿æŒä¸å…¶ä»–ä»»åŠ¡ä¸€è‡´(position, velocity, imu_vel, touch, extremities)
   - è‡ªåŠ¨å¤„ç†å¯å˜è‚¢ä½“æ•°é‡çš„è§‚æµ‹

---

## ğŸ”— ç›¸å…³æ–‡ä»¶ä½ç½®

```
derl/
â”œâ”€â”€ envs/
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ lunar_jump.py          â­ æ–°å¢ - ä»»åŠ¡å®šä¹‰
â”‚       â””â”€â”€ task.py                âœï¸ ä¿®æ”¹ - ä»»åŠ¡æ³¨å†Œ
â”œâ”€â”€ config.py                       âœï¸ ä¿®æ”¹ - å‚æ•°é…ç½®
â””â”€â”€ envs/
    â””â”€â”€ tasks/
        â””â”€â”€ unimal.py              âœï¸ ä¿®æ”¹ - é‡åŠ›åº”ç”¨

configs/
â””â”€â”€ evo/
    â””â”€â”€ lunar_jump.yml             â­ æ–°å¢ - è®­ç»ƒé…ç½®

test_lunar_jump_setup.py           â­ æ–°å¢ - éªŒè¯è„šæœ¬
```

---

## ä¸‹ä¸€æ­¥

1. **è¿è¡Œæµ‹è¯•è„šæœ¬**:
   ```bash
   python test_lunar_jump_setup.py
   ```

2. **å¯åŠ¨å°è§„æ¨¡è®­ç»ƒ**éªŒè¯:
   ```bash
   python tools/evolution.py --config configs/evo/lunar_jump.yml
   ```

3. **ç›‘æ§è¾“å‡º**:
   ```bash
   tail -f output/lunar_jump/log.txt
   ```

4. **æ ¹æ®ç»“æœè°ƒæ•´å‚æ•°**

ç¥ä½ çš„æœˆé¢è·³è·ƒæœºå™¨äººè®­ç»ƒé¡ºåˆ©ï¼ğŸš€
