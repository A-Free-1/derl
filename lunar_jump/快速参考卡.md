# æœˆé¢è·³è·ƒæœºå™¨äºº - å¿«é€Ÿå‚è€ƒå¡

## ä¸€å¥è¯æ€»ç»“
æƒ³åšæœˆé¢è·³è·ƒæœºå™¨äººï¼š**åˆ›å»ºä»»åŠ¡ + é…ç½®å‚æ•° + å¯åŠ¨è¿›åŒ–**

---

## æ–‡ä»¶é€ŸæŸ¥è¡¨

### ğŸ”´ å¿…çœ‹ï¼ˆå¿…æ”¹ï¼‰
| æ–‡ä»¶ | è¡Œå· | ä¸ºä»€ä¹ˆ | æ”¹ä»€ä¹ˆ |
|-----|------|-------|-------|
| `morphology.py` | 187-330 | æ„å‹ç”Ÿæˆæ ¸å¿ƒ | ç†è§£è‚¢ä½“å¦‚ä½•åˆ›å»º |
| `morphology.py` | 695-756 | ç”Ÿé•¿çªå˜æ ¸å¿ƒ | ç†è§£è‚¢ä½“å¦‚ä½•æ‰©å±• |
| `config.py` | 1-100 | å‚æ•°é…ç½® | æ·»åŠ æœˆé¢ç›¸å…³å‚æ•° |
| `evo_single_proc.py` | 40-100 | è¿›åŒ–å¾ªç¯ | è‡ªå®šä¹‰æœˆé¢å¥–åŠ± |

### ğŸŸ¡ éœ€çœ‹ï¼ˆå‚è€ƒï¼‰
| æ–‡ä»¶ | ç”¨é€” | å‚è€ƒå“ªä¸ª |
|-----|------|---------|
| `locomotion.py` | ä»»åŠ¡æ¡†æ¶ | `LocomotionTask` ç±» |
| `obstacle.py` | å¤æ‚ç¯å¢ƒ | å¤šwrapperçš„ç»„åˆ |
| `manipulation.py` | å¤šä»»åŠ¡ | å¤æ‚å¥–åŠ±è®¡ç®— |

### ğŸŸ¢ å¯é€‰ï¼ˆä¼˜åŒ–ï¼‰
| æ–‡ä»¶ | å¯åšçš„ä¼˜åŒ– | ä¼˜å…ˆçº§ |
|-----|---------|-------|
| `ppo.py` | æœˆé¢ç‰¹å®šç­–ç•¥ | ä½ |
| `hfield.py` | æœˆé¢è¡¨é¢å¥–åŠ± | ä½ |

---

## æ ¸å¿ƒç±»å’Œæ–¹æ³•é€ŸæŸ¥

### SymmetricUnimalï¼ˆæ„å‹ç®¡ç†ï¼‰
```python
unimal = SymmetricUnimal(id_=0)

# é‡è¦å±æ€§
unimal.limb_metadata      # è‚¢ä½“ä¿¡æ¯åº“
unimal.limb_list          # è‚¢ä½“åˆ—è¡¨ [[0,1],[2,3]]
unimal.num_limbs          # è‚¢ä½“æ•°é‡
unimal.body_params        # èº«ä½“å‚æ•°

# é‡è¦æ–¹æ³•
unimal.grow_limb()        # ç”Ÿé•¿è‚¢ä½“
unimal.mutate_limb_params()  # æ”¹å˜è‚¢ä½“å‚æ•°
unimal.mutate_joint()     # æ”¹å˜å…³èŠ‚
unimal.mutate_delete_limb()  # åˆ é™¤è‚¢ä½“
unimal.save()             # ä¿å­˜æ„å‹
```

### LunarJumpTaskï¼ˆéœ€è¦åˆ›å»ºï¼‰
```python
class LunarJumpTask(UnimalEnv):
    def __init__(self, xml_str, unimal_id):
        pass
    
    def step(self, action):
        # å…³é”®ï¼šè®¡ç®—è·³è·ƒé«˜åº¦ã€è·ç¦»
        # è¿”å›ï¼šobs, reward, done, info
        pass
    
    def reset(self):
        pass
```

### PPOï¼ˆè®­ç»ƒï¼‰
```python
ppo = PPO(env)
ppo.learn(total_timesteps)  # è®­ç»ƒ
```

---

## å…³é”®å‚æ•°å¯¹æœˆé¢è·³è·ƒçš„å½±å“

### 1. é‡åŠ›å‚æ•°ï¼ˆæœ€å…³é”®ï¼‰
```yaml
# æœˆçƒé‡åŠ› = 1.62 m/sÂ² (åœ°çƒçš„1/6)
GRAVITY: 1.62
# å½±å“ï¼šè‚¢ä½“é•¿åº¦åº”æ›´é•¿ï¼Œè·³è·ƒåŠ›åº¦åº”æ›´å¼º
```

### 2. è‚¢ä½“å‚æ•°
```python
LIMB.HEIGHT_RANGE = [0.1, 0.3, 0.05]  # æ›´é•¿çš„è‚¢ä½“
LIMB.RADIUS_RANGE = [0.03, 0.08]      # æ›´ç»†çš„è‚¢ä½“
LIMB.MAX_LIMBS = 10                    # è‚¢ä½“æ•°é‡é™åˆ¶
```

### 3. ä»»åŠ¡å¥–åŠ±
```python
# éœ€è¦æ·»åŠ çš„å¥–åŠ±é¡¹
forward_reward = 1.0 * horizontal_distance  # æ°´å¹³è·ç¦»
jump_reward = 10.0 * jump_height            # è·³è·ƒé«˜åº¦ï¼ˆåŠ æƒï¼‰
energy_cost = 0.001 * energy_used           # èƒ½é‡ä»£ä»·
total_reward = forward_reward + jump_reward - energy_cost
```

### 4. ç¯å¢ƒå‚æ•°
```python
ENV.TASK = "lunar_jump"           # ä»»åŠ¡ç±»å‹
ENV.GRAVITY_SCALE = 0.165          # é‡åŠ›ç¼©æ”¾
ENV.FORWARD_REWARD_WEIGHT = 1.0   # å‰è¿›å¥–åŠ±æƒé‡
```

---

## å®ç°æ­¥éª¤ï¼ˆä»0åˆ°1ï¼‰

### Step 1: åˆ›å»ºä»»åŠ¡æ–‡ä»¶ï¼ˆ10åˆ†é’Ÿï¼‰
```bash
cp derl/envs/tasks/locomotion.py derl/envs/tasks/lunar_jump.py
# ç¼–è¾‘ï¼šæ”¹ç±»åã€æ”¹å¥–åŠ±è®¡ç®—ã€æ·»åŠ è·³è·ƒé«˜åº¦è®¡ç®—
```

### Step 2: ä¿®æ”¹task.pyï¼ˆ2åˆ†é’Ÿï¼‰
```python
# åœ¨ derl/envs/tasks/task.py ä¸­
from derl.envs.tasks.lunar_jump import make_env_lunar_jump

# åœ¨ TASK_REGISTRY ä¸­æ·»åŠ 
"lunar_jump": make_env_lunar_jump
```

### Step 3: ä¿®æ”¹config.pyï¼ˆ5åˆ†é’Ÿï¼‰
```python
# åœ¨ derl/config.py ä¸­æ·»åŠ 
_C.ENV.GRAVITY = 1.62
_C.ENV.JUMP_REWARD_WEIGHT = 10.0
_C.ENV.ENERGY_COST_WEIGHT = 0.001
```

### Step 4: åˆ›å»ºé…ç½®æ–‡ä»¶ï¼ˆ2åˆ†é’Ÿï¼‰
```bash
cp configs/evo/ft.yml configs/evo/lunar_jump.yml
# ç¼–è¾‘ï¼šæ”¹ TASK, OUT_DIR, è°ƒå‚æ•°
```

### Step 5: å¯åŠ¨è®­ç»ƒï¼ˆ1ç§’ï¼‰
```bash
python tools/evolution.py --config configs/evo/lunar_jump.yml
```

---

## å…³é”®å‡½æ•°è°ƒç”¨æµ

```
evolution.py (ä¸»ç¨‹åº)
  â”œâ”€ init_population()          # ç”Ÿæˆåˆå§‹ç§ç¾¤
  â”‚   â””â”€ SymmetricUnimal()      # åˆ›å»º64ä¸ªæœºå™¨äºº
  â”‚
  â”œâ”€ ppo_train(ä¸ªä½“)            # è®­ç»ƒå•ä¸ªæœºå™¨äºº
  â”‚   â””â”€ make_env_lunar_jump()  # åˆ›å»ºç¯å¢ƒ
  â”‚       â””â”€ step(action)       # æ¯ä¸€æ­¥
  â”‚           â”œâ”€ ä»¿çœŸç‰©ç†
  â”‚           â”œâ”€ è®¡ç®—è·³è·ƒé«˜åº¦
  â”‚           â””â”€ è®¡ç®—å¥–åŠ±
  â”‚
  â””â”€ tournament_evolution()     # è¿›åŒ–é€‰æ‹©å’Œçªå˜
      â””â”€ unimal.mutate()        # ç”Ÿæˆæ–°æ„å‹
          â”œâ”€ grow_limb()
          â”œâ”€ mutate_limb_params()
          â””â”€ mutate_joint()
```

---

## ä»£ç ç‰‡æ®µ

### è®¡ç®—è·³è·ƒé«˜åº¦
```python
def _calculate_jump_height(self):
    # è·å–èº¯å¹²æœ€é«˜ç‚¹
    torso_pos = self.sim.data.get_body_xpos("torso/0")[2]
    # ä¸resetæ—¶çš„é«˜åº¦æ¯”è¾ƒ
    height = torso_pos - self.reset_torso_height
    return max(0, height)
```

### è®¡ç®—è·³è·ƒè·ç¦»
```python
def _calculate_jump_distance(self):
    # æ°´å¹³ä½ç§»
    xy_pos = self.sim.data.get_body_xpos("torso/0")[:2]
    distance = np.linalg.norm(xy_pos - self.prev_xy_pos)
    return distance
```

### å¥–åŠ±è®¡ç®—
```python
def step(self, action):
    self.do_simulation(action)
    
    jump_height = self._calculate_jump_height()
    jump_distance = self._calculate_jump_distance()
    energy = self.calculate_energy()
    
    # å¤šç›®æ ‡å¥–åŠ±
    reward = (
        1.0 * jump_distance +           # æ°´å¹³è·ç¦»
        10.0 * jump_height +            # è·³è·ƒé«˜åº¦
        -0.001 * energy                 # èƒ½é‡ä»£ä»·
    )
    
    info = {
        "jump_height": jump_height,
        "jump_distance": jump_distance,
        "__reward__energy": energy
    }
    
    return obs, reward, done, info
```

---

## å¸¸è§é—®é¢˜å¿«é€Ÿç­”æ¡ˆ

### Q: å¦‚ä½•æ”¹é‡åŠ›ï¼Ÿ
**A**: åœ¨config.pyä¸­æ”¹ `_C.ENV.GRAVITY = 1.62`

### Q: å¦‚ä½•æ”¹è‚¢ä½“å°ºå¯¸ï¼Ÿ
**A**: åœ¨config.pyä¸­æ”¹ `_C.LIMB.HEIGHT_RANGE` å’Œ `_C.LIMB.RADIUS_RANGE`

### Q: å¦‚ä½•æ·»åŠ è·³è·ƒå¥–åŠ±ï¼Ÿ
**A**: åœ¨step()ä¸­è®¡ç®—è·³è·ƒé«˜åº¦ï¼ŒåŠ å…¥å¥–åŠ±ï¼š`reward += 10.0 * jump_height`

### Q: å¦‚ä½•å¯åŠ¨è®­ç»ƒï¼Ÿ
**A**: `python tools/evolution.py --config configs/evo/lunar_jump.yml`

### Q: ç»“æœä¿å­˜åœ¨å“ªï¼Ÿ
**A**: `output/lunar_jump/` ç›®å½•ä¸‹

### Q: å¦‚ä½•è¯„ä¼°ç»“æœï¼Ÿ
**A**: æŸ¥çœ‹ `output/lunar_jump/metadata/` ä¸­çš„jsonæ–‡ä»¶ï¼ŒåŒ…å«æ¯ä¸ªä¸ªä½“çš„å¥–åŠ±

---

## æ–‡ä»¶ä¿®æ”¹æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º `derl/envs/tasks/lunar_jump.py`
- [ ] ä¿®æ”¹ `derl/envs/tasks/task.py` (æ·»åŠ importå’Œregistry)
- [ ] ä¿®æ”¹ `derl/config.py` (æ·»åŠ æœˆé¢å‚æ•°)
- [ ] åˆ›å»º `configs/evo/lunar_jump.yml`
- [ ] ä¿®æ”¹ `tools/evo_single_proc.py` (å¯é€‰ï¼šè‡ªå®šä¹‰å¥–åŠ±)
- [ ] æµ‹è¯•ä»»åŠ¡: `python -c "from derl.envs.tasks.task import make_env; env = make_env()"`
- [ ] å¯åŠ¨è®­ç»ƒ

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆå§‹ç§ç¾¤**ï¼š20-64ä¸ª
2. **è®­ç»ƒæ­¥æ•°**ï¼š256æ­¥ (è¾ƒçŸ­ï¼Œä¿è¯è¿›åŒ–é€Ÿåº¦)
3. **è¿›åŒ–ä»£æ•°**ï¼š100-500ä»£
4. **ç§ç¾¤å¤§å°**ï¼š64ä¸ªæ´»è·ƒä¸ªä½“
5. **çªå˜æ¦‚ç‡**ï¼šå¹³è¡¡æ¢ç´¢å’Œå¼€å‘

---

## é¢„æœŸç»“æœ

### ç¬¬0ä»£ï¼ˆåˆå§‹åŒ–ï¼‰
- æ„å‹ï¼š4-6æ¡è‚¢ä½“
- è·³è·ƒé«˜åº¦ï¼š0.1-0.3m

### ç¬¬10ä»£
- æ„å‹ï¼š5-8æ¡è‚¢ä½“
- è·³è·ƒé«˜åº¦ï¼š0.3-0.5m

### ç¬¬50ä»£
- æ„å‹ï¼š6-10æ¡è‚¢ä½“ï¼ˆä¼˜åŒ–åï¼‰
- è·³è·ƒé«˜åº¦ï¼š0.5-1.0m

### ç¬¬100ä»£
- æ„å‹ï¼šç¨³å®šåœ¨8æ¡è‚¢ä½“
- è·³è·ƒé«˜åº¦ï¼š1.0-2.0mï¼ˆæœˆé¢æ¨¡æ‹Ÿï¼‰

---

## å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨è®­ç»ƒ
python tools/evolution.py --config configs/evo/lunar_jump.yml

# æŸ¥çœ‹ç»“æœ
ls output/lunar_jump/metadata/ | head -20

# æå–æœ€ä½³ä¸ªä½“çš„å¥–åŠ±
grep -h "__reward__" output/lunar_jump/metadata/*.json | head -20

# åç»­è®­ç»ƒï¼ˆä»checkpointç»§ç»­ï¼‰
python tools/evolution.py --config configs/evo/lunar_jump.yml \
  --checkpoint output/lunar_jump/best_unimal.pkl
```

---

## è°ƒè¯•æŠ€å·§

```python
# æµ‹è¯•å•ä¸ªç¯å¢ƒ
import sys
sys.path.insert(0, '/home/t/yb/agrimgupta_derl/derl')

from derl.envs.tasks.task import make_env
env = make_env(xml_path='derl/envs/assets/unimal.xml')
obs = env.reset()

for i in range(100):
    action = env.action_space.sample()
    obs, reward, done, info = env.step(action)
    print(f"Step {i}: jump_height={info.get('jump_height', 0):.3f}, reward={reward:.3f}")
```

